# ğŸ’³ ECPay ç¶ ç•Œé‡‘æµæŠ€è¡“åˆ†æèˆ‡é¢è©¦æŒ‡å—

> å®Œæ•´è§£æ NGO ç³»çµ±ä¸­ ECPay ç¶ ç•Œé‡‘æµçš„å¯¦ç¾åŸç†ã€ç‹€æ…‹ç®¡ç†ã€å®‰å…¨æ©Ÿåˆ¶

**æœ€å¾Œæ›´æ–°**ï¼š2025-12-29

---

## ğŸ“‹ ç›®éŒ„

1. [æŠ€è¡“æ¶æ§‹ç¸½è¦½](#æŠ€è¡“æ¶æ§‹ç¸½è¦½)
2. [ä»˜æ¬¾æµç¨‹è©³è§£](#ä»˜æ¬¾æµç¨‹è©³è§£)
3. [é é¢è·³è½‰æ©Ÿåˆ¶](#é é¢è·³è½‰æ©Ÿåˆ¶)
4. [ç‹€æ…‹ç®¡ç†èˆ‡è³‡æ–™å„²å­˜](#ç‹€æ…‹ç®¡ç†èˆ‡è³‡æ–™å„²å­˜)
5. [å®‰å…¨æ©Ÿåˆ¶](#å®‰å…¨æ©Ÿåˆ¶)
6. [é¢è©¦å¸¸è¦‹å•é¡Œ](#é¢è©¦å¸¸è¦‹å•é¡Œ)
7. [æŠ€è¡“äº®é»](#æŠ€è¡“äº®é»)

---

## ğŸ— æŠ€è¡“æ¶æ§‹ç¸½è¦½

### ç³»çµ±æ¶æ§‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ°‘çœ¾/å€‹æ¡ˆ   â”‚ é¸æ“‡ç‰©è³‡ã€å¡«å¯«è³‡æ–™
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Purchase     â”‚ å»ºç«‹è¨‚å–® (OrderNumber: NGO20251229143052)
â”‚ Controller   â”‚ å„²å­˜è¨‚å–®ç‹€æ…‹ï¼šã€Œå¾…ä»˜æ¬¾ã€
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EcpayService â”‚ ç”Ÿæˆä»˜æ¬¾è¡¨å–® (HTML Form)
â”‚              â”‚ è¨ˆç®— CheckMacValue (SHA256 åŠ å¯†)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ (è‡ªå‹•æäº¤è¡¨å–®)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ECPay ç¶ ç•Œ   â”‚ ç”¨æˆ¶åœ¨ç¶ ç•Œé é¢å®Œæˆä»˜æ¬¾
â”‚ ä»˜æ¬¾é é¢     â”‚ è¼¸å…¥æ¸¬è©¦å¡è™Ÿï¼š4311-9511-1111-1111
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                  â”‚
       â†“                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ReturnURL    â”‚   â”‚ ClientBackURLâ”‚
â”‚ (Serverå›èª¿) â”‚   â”‚ (é é¢è·³è½‰)   â”‚
â”‚              â”‚   â”‚              â”‚
â”‚ EcpayCallbackâ”‚   â”‚ PaymentSuccessâ”‚
â”‚              â”‚   â”‚              â”‚
â”‚ é©—è­‰å®‰å…¨æ€§   â”‚   â”‚ é¡¯ç¤ºçµæœçµ¦   â”‚
â”‚ æ›´æ–°è¨‚å–®ç‹€æ…‹ â”‚   â”‚ ä½¿ç”¨è€…       â”‚
â”‚ æ›´æ–°åº«å­˜     â”‚   â”‚              â”‚
â”‚              â”‚   â”‚              â”‚
â”‚ è¿”å›ï¼š1|OK   â”‚   â”‚ Success é é¢ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒæª”æ¡ˆ

| æª”æ¡ˆ | åŠŸèƒ½ | è¡Œæ•¸ |
|------|------|------|
| **EcpayService.cs** | ECPay é‡‘æµæ ¸å¿ƒæœå‹™ | ~340 è¡Œ |
| **PurchaseController.cs** | è³¼è²·æµç¨‹æ§åˆ¶å™¨ | ~1170 è¡Œ |
| **EcpayTransaction.cs** | äº¤æ˜“è¨˜éŒ„è³‡æ–™æ¨¡å‹ | Entity |
| **UserOrder.cs** | ç”¨æˆ¶è¨‚å–®è³‡æ–™æ¨¡å‹ | Entity |

---

## ğŸ”„ ä»˜æ¬¾æµç¨‹è©³è§£

### å®Œæ•´æµç¨‹æ™‚åºåœ–

```
ç”¨æˆ¶          Controller         Service          ECPay         Database
 â”‚                â”‚                â”‚                â”‚             â”‚
 â”‚ 1. é¸æ“‡ç‰©è³‡    â”‚                â”‚                â”‚             â”‚
 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚                â”‚             â”‚
 â”‚                â”‚                â”‚                â”‚             â”‚
 â”‚                â”‚ 2. å»ºç«‹è¨‚å–®     â”‚                â”‚             â”‚
 â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                â”‚                â”‚                â”‚             â”‚
 â”‚                â”‚                â”‚                â”‚   UserOrder â”‚
 â”‚                â”‚                â”‚                â”‚   - OrderNumber: NGO20251229143052
 â”‚                â”‚                â”‚                â”‚   - PaymentStatus: "å¾…ä»˜æ¬¾"
 â”‚                â”‚                â”‚                â”‚   - TotalPrice: 100
 â”‚                â”‚                â”‚                â”‚             â”‚
 â”‚                â”‚ 3. å‘¼å« ECPay  â”‚                â”‚             â”‚
 â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚             â”‚
 â”‚                â”‚                â”‚                â”‚             â”‚
 â”‚                â”‚                â”‚ 4. å»ºç«‹äº¤æ˜“è¨˜éŒ„â”‚             â”‚
 â”‚                â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                â”‚                â”‚                â”‚             â”‚
 â”‚                â”‚                â”‚                â”‚   EcpayTransaction
 â”‚                â”‚                â”‚                â”‚   - Status: "Pending"
 â”‚                â”‚                â”‚                â”‚   - EcpayTradeNo: NGO20251229143052
 â”‚                â”‚                â”‚                â”‚             â”‚
 â”‚                â”‚                â”‚ 5. ç”Ÿæˆ CheckMacValue        â”‚
 â”‚                â”‚                â”‚   (SHA256 åŠ å¯†)              â”‚
 â”‚                â”‚                â”‚                â”‚             â”‚
 â”‚                â”‚                â”‚ 6. ç”¢ç”Ÿ HTMLè¡¨å–®â”‚             â”‚
 â”‚                â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚             â”‚
 â”‚                â”‚                â”‚                â”‚             â”‚
 â”‚ 7. è¿”å›è¡¨å–®é   â”‚                â”‚                â”‚             â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚                â”‚             â”‚
 â”‚                â”‚                â”‚                â”‚             â”‚
 â”‚ 8. è‡ªå‹•æäº¤è¡¨å–®åˆ° ECPay                          â”‚             â”‚
 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚             â”‚             â”‚
 â”‚                â”‚                â”‚                â”‚             â”‚
 â”‚ 9. åœ¨ ECPay é é¢å®Œæˆä»˜æ¬¾          â”‚             â”‚             â”‚
 â”‚                â”‚                â”‚                â”‚             â”‚
 â”‚ 10. ECPay å›èª¿ ReturnURL (Server-to-Server)     â”‚             â”‚
 â”‚                â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚             â”‚
 â”‚                â”‚                â”‚                â”‚             â”‚
 â”‚                â”‚ 11. é©—è­‰ CheckMacValue           â”‚             â”‚
 â”‚                â”‚                â”‚                â”‚             â”‚
 â”‚                â”‚ 12. æ›´æ–°è¨‚å–®ç‹€æ…‹â”‚                â”‚             â”‚
 â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                â”‚                â”‚                â”‚             â”‚
 â”‚                â”‚                â”‚                â”‚   PaymentStatus: "å·²ä»˜æ¬¾"
 â”‚                â”‚                â”‚                â”‚   CollectedQuantity += Quantity
 â”‚                â”‚                â”‚                â”‚             â”‚
 â”‚                â”‚ 13. è¿”å› 1|OK  â”‚                â”‚             â”‚
 â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚             â”‚
 â”‚                â”‚                â”‚                â”‚             â”‚
 â”‚ 14. ECPay è·³è½‰ ClientBackURL (ç”¨æˆ¶ç€è¦½å™¨)        â”‚             â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚             â”‚
 â”‚                â”‚                â”‚                â”‚             â”‚
 â”‚ 15. é¡¯ç¤ºæˆåŠŸé é¢â”‚                â”‚                â”‚             â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚                â”‚             â”‚
```

### é—œéµæ­¥é©Ÿèªªæ˜

#### æ­¥é©Ÿ 1-2ï¼šå»ºç«‹è¨‚å–® (PurchaseController.cs:308-636)

```csharp
// ç”¢ç”Ÿå”¯ä¸€è¨‚å–®ç·¨è™Ÿ
var orderNumber = GenerateOrderNumber(); // NGO20251229143052

// å»ºç«‹è¨‚å–®
var order = new UserOrder
{
    UserId = model.UserId.Value,
    OrderNumber = orderNumber,
    OrderDate = DateTime.Now,
    TotalPrice = model.TotalPrice,
    PaymentStatus = "å¾…ä»˜æ¬¾",      // â­ é‡è¦ï¼šåˆå§‹ç‹€æ…‹
    PaymentMethod = "ecpay",
    OrderSource = model.EmergencyNeedId.HasValue ? "emergency" : "regular"
};

_context.UserOrders.Add(order);
await _context.SaveChangesAsync();
```

#### æ­¥é©Ÿ 3-6ï¼šç”Ÿæˆ ECPay ä»˜æ¬¾è¡¨å–® (EcpayService.cs:28-114)

```csharp
public string CreatePayment(UserOrder order, string returnUrl, string clientBackUrl)
{
    // 1. å»ºç«‹ ECPay äº¤æ˜“è¨˜éŒ„
    var ecpayTransaction = new EcpayTransaction
    {
        UserOrderId = order.UserOrderId,
        Status = "Pending",          // â­ äº¤æ˜“ç‹€æ…‹ï¼šå¾…è™•ç†
        CreatedDateTime = DateTime.Now
    };
    _context.EcpayTransactions.Add(ecpayTransaction);
    _context.SaveChanges();

    // 2. å»ºç«‹ä»˜æ¬¾åƒæ•¸
    var parameters = new Dictionary<string, string>
    {
        ["MerchantID"] = _merchantId,              // 3002607 (æ¸¬è©¦å•†åº—)
        ["MerchantTradeNo"] = order.OrderNumber,   // NGO20251229143052
        ["MerchantTradeDate"] = DateTime.Now.ToString("yyyy/MM/dd HH:mm:ss"),
        ["PaymentType"] = "aio",
        ["TotalAmount"] = ((int)order.TotalPrice).ToString(),
        ["ReturnURL"] = returnUrl,                 // Server å›èª¿ç¶²å€
        ["ClientBackURL"] = clientBackURL,         // ç”¨æˆ¶è·³è½‰ç¶²å€
        ["ChoosePayment"] = "ALL"
    };

    // 3. ç”Ÿæˆ CheckMacValue (å®‰å…¨é©—è­‰ç¢¼)
    var checkMacValue = GenerateCheckMacValue(parameters, _hashKey, _hashIv);
    parameters["CheckMacValue"] = checkMacValue;

    // 4. ç”¢ç”Ÿ HTML è¡¨å–®
    var formHtml = GeneratePaymentForm(parameters);

    return formHtml;
}
```

#### æ­¥é©Ÿ 7-9ï¼šé é¢è·³è½‰åˆ° ECPay (è‡ªå‹•æäº¤è¡¨å–®)

```html
<!-- EcpayRedirect.cshtml -->
<form id='ecpayForm' method='post' action='https://payment-stage.ecpay.com.tw/Cashier/AioCheckOut/V5'>
    <input type='hidden' name='MerchantID' value='3002607' />
    <input type='hidden' name='MerchantTradeNo' value='NGO20251229143052' />
    <input type='hidden' name='TotalAmount' value='100' />
    <input type='hidden' name='ReturnURL' value='https://your-domain.com/Purchase/EcpayCallback' />
    <input type='hidden' name='ClientBackURL' value='https://your-domain.com/Purchase/PaymentSuccess' />
    <input type='hidden' name='CheckMacValue' value='A1B2C3...' />
    <!-- ... å…¶ä»–åƒæ•¸ ... -->
</form>

<script>
    document.getElementById('ecpayForm').submit(); // â­ è‡ªå‹•æäº¤
</script>
```

#### æ­¥é©Ÿ 10-13ï¼šECPay å›èª¿é©—è­‰ (EcpayService.cs:116-170)

```csharp
[HttpPost]
[AllowAnonymous]  // â­ å…è¨±åŒ¿åè¨ªå•ï¼ˆECPay Server å›èª¿ï¼‰
public IActionResult EcpayCallback()
{
    // 1. æ¥æ”¶ ECPay å›èª¿åƒæ•¸
    var parameters = Request.Form.ToDictionary(x => x.Key, x => x.Value.ToString());

    // 2. é©—è­‰ä¸¦è™•ç†
    var success = _ecpayService.ProcessCallback(parameters);

    // 3. è¿”å›çµ¦ ECPayï¼ˆå¿…é ˆï¼ï¼‰
    return Content(success ? "1|OK" : "0|ERROR");
}

public bool ProcessCallback(Dictionary<string, string> parameters)
{
    // 1. æå–é—œéµåƒæ•¸
    var merchantTradeNo = parameters["MerchantTradeNo"];  // NGO20251229143052
    var rtnCode = parameters["RtnCode"];                  // "1" = æˆåŠŸ
    var receivedCheckMacValue = parameters["CheckMacValue"];

    // 2. â­ å®‰å…¨é©—è­‰ï¼šé‡æ–°è¨ˆç®— CheckMacValue
    var calculatedCheckMacValue = GenerateCallbackCheckMacValue(parameters, _hashKey, _hashIv);
    if (calculatedCheckMacValue != receivedCheckMacValue)
    {
        return false;  // é©—è­‰å¤±æ•—ï¼Œå¯èƒ½æ˜¯å½é€ çš„å›èª¿
    }

    // 3. æŸ¥æ‰¾è¨‚å–®
    var order = _context.UserOrders.FirstOrDefault(o => o.OrderNumber == merchantTradeNo);
    var ecpayTransaction = _context.EcpayTransactions.FirstOrDefault(e => e.EcpayTradeNo == merchantTradeNo);

    // 4. æ›´æ–°è¨‚å–®ç‹€æ…‹
    if (rtnCode == "1")
    {
        ecpayTransaction.Status = "Success";
        order.PaymentStatus = "å·²ä»˜æ¬¾";          // â­ æ›´æ–°ä»˜æ¬¾ç‹€æ…‹

        // 5. æ›´æ–°åº«å­˜ï¼ˆä»˜æ¬¾æˆåŠŸå¾Œï¼‰
        UpdateInventoryAndEmergencyNeeds(order);
    }

    _context.SaveChanges();
    return rtnCode == "1";
}
```

---

## ğŸ”€ é é¢è·³è½‰æ©Ÿåˆ¶

### å…©ç¨® URL çš„å€åˆ¥

| URL é¡å‹ | åç¨± | ç”¨é€” | è§¸ç™¼æ™‚æ©Ÿ | èª°è¨ªå• |
|---------|------|------|---------|--------|
| **ReturnURL** | Server å›èª¿ç¶²å€ | æ›´æ–°è¨‚å–®ç‹€æ…‹ã€é©—è­‰å®‰å…¨æ€§ | ä»˜æ¬¾å®Œæˆå¾Œç«‹å³ | ECPay Server |
| **ClientBackURL** | é é¢è·³è½‰ç¶²å€ | é¡¯ç¤ºçµæœçµ¦ç”¨æˆ¶ | ä»˜æ¬¾å®Œæˆå¾Œ | ç”¨æˆ¶ç€è¦½å™¨ |

### ç‚ºä»€éº¼éœ€è¦å…©å€‹ URLï¼Ÿ

```
âŒ éŒ¯èª¤åšæ³•ï¼šåªç”¨ ClientBackURL
   å•é¡Œï¼šç”¨æˆ¶å¯ä»¥æ‰‹å‹•é—œé–‰ç€è¦½å™¨ï¼Œä¸æœƒè§¸ç™¼å›èª¿
   çµæœï¼šè¨‚å–®æ°¸é åœç•™åœ¨ã€Œå¾…ä»˜æ¬¾ã€ç‹€æ…‹

âœ… æ­£ç¢ºåšæ³•ï¼šReturnURL + ClientBackURL
   ReturnURLï¼š  ç”± ECPay Server ä¸»å‹•å‘¼å«ï¼Œä¿è­‰åŸ·è¡Œ
   ClientBackURLï¼šç”¨æˆ¶çœ‹åˆ°çµæœé é¢ï¼Œé«”é©—è‰¯å¥½
```

### è·³è½‰æµç¨‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ¶ä»˜æ¬¾   â”‚ åœ¨ ECPay é é¢è¼¸å…¥ä¿¡ç”¨å¡è³‡è¨Š
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                        â”‚
       â†“ (Server-to-Server)     â†“ (Browser Redirect)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ReturnURL    â”‚          â”‚ClientBackURL â”‚
â”‚              â”‚          â”‚              â”‚
â”‚ /Purchase/   â”‚          â”‚ /Purchase/   â”‚
â”‚ EcpayCallbackâ”‚          â”‚ PaymentSuccessâ”‚
â”‚              â”‚          â”‚              â”‚
â”‚ [AllowAnonymous]        â”‚              â”‚
â”‚              â”‚          â”‚              â”‚
â”‚ 1. é©—è­‰å®‰å…¨æ€§â”‚          â”‚ 1. æŸ¥è©¢è¨‚å–®  â”‚
â”‚ 2. æ›´æ–°è¨‚å–®  â”‚          â”‚ 2. é¡¯ç¤ºçµæœ  â”‚
â”‚ 3. æ›´æ–°åº«å­˜  â”‚          â”‚              â”‚
â”‚              â”‚          â”‚              â”‚
â”‚ è¿”å›ï¼š1|OK   â”‚          â”‚ è¿”å›ï¼šView   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Cloudflare Tunnel çš„å¿…è¦æ€§

```
æœ¬åœ°é–‹ç™¼ (localhost:5066)
â”œâ”€ ReturnURL:  http://localhost:5066/Purchase/EcpayCallback  âŒ ECPay ç„¡æ³•è¨ªå•
â””â”€ ClientBackURL: http://localhost:5066/Purchase/PaymentSuccess  âŒ ECPay ç„¡æ³•è¨ªå•

ä½¿ç”¨ Cloudflare Tunnel
â”œâ”€ ReturnURL:  https://extended-prep-garden-manufacture.trycloudflare.com/Purchase/EcpayCallback  âœ…
â””â”€ ClientBackURL: https://extended-prep-garden-manufacture.trycloudflare.com/Purchase/PaymentSuccess  âœ…
```

**ç‚ºä»€éº¼éœ€è¦ Cloudflareï¼Ÿ**
- ECPay Server éœ€è¦**å…¬é–‹ç¶²å€**æ‰èƒ½å›èª¿
- localhost åªèƒ½åœ¨æœ¬æ©Ÿè¨ªå•ï¼Œå¤–éƒ¨ç„¡æ³•é€£æ¥
- Cloudflare Tunnel å°‡æœ¬åœ°æœå‹™æš´éœ²ç‚ºå…¬é–‹ç¶²å€

---

## ğŸ’¾ ç‹€æ…‹ç®¡ç†èˆ‡è³‡æ–™å„²å­˜

### è³‡æ–™åº«è¨­è¨ˆ

#### 1. UserOrderï¼ˆç”¨æˆ¶è¨‚å–®è¡¨ï¼‰

| æ¬„ä½ | é¡å‹ | èªªæ˜ | ç¯„ä¾‹å€¼ |
|------|------|------|--------|
| UserOrderId | int (PK) | è¨‚å–®ID | 123 |
| UserId | int (FK) | ç”¨æˆ¶ID | 45 |
| **OrderNumber** | string(20) | è¨‚å–®ç·¨è™Ÿï¼ˆå”¯ä¸€ï¼‰ | NGO20251229143052 |
| OrderDate | datetime | è¨‚å–®æ—¥æœŸ | 2025-12-29 14:30:52 |
| TotalPrice | decimal | è¨‚å–®ç¸½åƒ¹ | 100.00 |
| **PaymentStatus** | string | ä»˜æ¬¾ç‹€æ…‹ | ã€Œå¾…ä»˜æ¬¾ã€â†’ã€Œå·²ä»˜æ¬¾ã€ |
| PaymentMethod | string | ä»˜æ¬¾æ–¹å¼ | "ecpay" |
| OrderSource | string | è¨‚å–®ä¾†æº | "emergency" / "regular" |
| EmergencyNeedId | int? | ç·Šæ€¥éœ€æ±‚ID | 15 (nullable) |

#### 2. EcpayTransactionï¼ˆECPay äº¤æ˜“è¨˜éŒ„è¡¨ï¼‰

| æ¬„ä½ | é¡å‹ | èªªæ˜ | ç¯„ä¾‹å€¼ |
|------|------|------|--------|
| Id | int (PK) | äº¤æ˜“ID | 789 |
| UserOrderId | int (FK) | é—œè¯è¨‚å–® | 123 |
| **EcpayTradeNo** | string | ECPay äº¤æ˜“ç·¨è™Ÿ | NGO20251229143052 |
| **Status** | string | äº¤æ˜“ç‹€æ…‹ | "Pending" â†’ "Success" |
| CreatedDateTime | datetime | å»ºç«‹æ™‚é–“ | 2025-12-29 14:30:52 |
| ResponseData | string (JSON) | ECPay å›èª¿è³‡æ–™ | {"RtnCode":"1",...} |

### ç‹€æ…‹è½‰æ›æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ç”¨æˆ¶é¸æ“‡ç‰©è³‡ã€å¡«å¯«è³‡æ–™                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. å»ºç«‹è¨‚å–®                              â”‚
â”‚    UserOrder:                            â”‚
â”‚    - OrderNumber: NGO20251229143052      â”‚
â”‚    - PaymentStatus: "å¾…ä»˜æ¬¾"  â­        â”‚
â”‚    - TotalPrice: 100                     â”‚
â”‚                                          â”‚
â”‚    EcpayTransaction:                     â”‚
â”‚    - Status: "Pending"  â­               â”‚
â”‚    - EcpayTradeNo: NGO20251229143052     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. è·³è½‰åˆ° ECPay ä»˜æ¬¾é é¢                â”‚
â”‚    (ç”¨æˆ¶é›¢é–‹æˆ‘å€‘çš„ç¶²ç«™)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. ç”¨æˆ¶å®Œæˆä»˜æ¬¾                          â”‚
â”‚    (åœ¨ ECPay ç¶²ç«™ä¸Š)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. ECPay å›èª¿ ReturnURL                  â”‚
â”‚    (Server-to-Server)                    â”‚
â”‚                                          â”‚
â”‚    â­ æ›´æ–°ç‹€æ…‹ï¼š                          â”‚
â”‚    UserOrder:                            â”‚
â”‚    - PaymentStatus: "å·²ä»˜æ¬¾"  âœ…        â”‚
â”‚                                          â”‚
â”‚    EcpayTransaction:                     â”‚
â”‚    - Status: "Success"  âœ…               â”‚
â”‚    - ResponseData: {JSON}                â”‚
â”‚                                          â”‚
â”‚    â­ æ›´æ–°åº«å­˜ï¼š                          â”‚
â”‚    EmergencySupplyNeeds:                 â”‚
â”‚    - CollectedQuantity += Quantity       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. ECPay è·³è½‰ ClientBackURL              â”‚
â”‚    (ç”¨æˆ¶ç€è¦½å™¨è·³è½‰å›æˆ‘å€‘çš„ç¶²ç«™)          â”‚
â”‚                                          â”‚
â”‚    PaymentSuccess Action:                â”‚
â”‚    - æŸ¥è©¢è¨‚å–®ç‹€æ…‹ï¼ˆå·²æ˜¯"å·²ä»˜æ¬¾"ï¼‰        â”‚
â”‚    - é¡¯ç¤ºæˆåŠŸé é¢çµ¦ç”¨æˆ¶                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é—œéµï¼šç‹€æ…‹ä¸€è‡´æ€§ä¿è­‰

#### å•é¡Œï¼šå¦‚æœç”¨æˆ¶é—œé–‰ç€è¦½å™¨æ€éº¼è¾¦ï¼Ÿ

```
æƒ…å¢ƒ Aï¼šåªç”¨ ClientBackURL
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ç”¨æˆ¶ä»˜æ¬¾æˆåŠŸâ”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚
     â†“ (ç€è¦½å™¨è·³è½‰)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        âŒ ç”¨æˆ¶æ‰‹å‹•é—œé–‰ç€è¦½å™¨
â”‚ClientBackâ”‚ â”€â”€â”€â”€â”€â”€â”€â”€â†’ è·³è½‰æ²’ç™¼ç”Ÿï¼
â”‚   URL    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

çµæœï¼šè¨‚å–®æ°¸é æ˜¯ã€Œå¾…ä»˜æ¬¾ã€ï¼Œä½†å¯¦éš›å·²ä»˜æ¬¾ âŒ


æƒ…å¢ƒ Bï¼šReturnURL + ClientBackURL
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ç”¨æˆ¶ä»˜æ¬¾æˆåŠŸâ”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
      â”‚
      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                â”‚
      â†“ (Serverå›èª¿)   â†“ (ç€è¦½å™¨è·³è½‰)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Return   â”‚      â”‚ Client   â”‚
â”‚  URL     â”‚      â”‚ BackURL  â”‚  âŒ ç”¨æˆ¶é—œé–‰ç€è¦½å™¨
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     âœ… ECPay Server å¿…å®šå‘¼å«
     â†“
è¨‚å–®ç‹€æ…‹å·²æ›´æ–°ç‚ºã€Œå·²ä»˜æ¬¾ã€ âœ…

çµæœï¼šå³ä½¿ç”¨æˆ¶é—œé–‰ç€è¦½å™¨ï¼Œè¨‚å–®ç‹€æ…‹ä»æ­£ç¢ºï¼âœ…
```

---

## ğŸ”’ å®‰å…¨æ©Ÿåˆ¶

### 1. CheckMacValue é©—è­‰ï¼ˆé˜²å½é€ å›èª¿ï¼‰

#### ä»€éº¼æ˜¯ CheckMacValueï¼Ÿ

```
CheckMacValue æ˜¯ä¸€å€‹ SHA256 åŠ å¯†çš„å­—ä¸²ï¼Œç”¨ä¾†ç¢ºä¿è³‡æ–™æœªè¢«ç«„æ”¹ã€‚

è¨ˆç®—å…¬å¼ï¼š
CheckMacValue = SHA256(
    "HashKey={HashKey}&{æ’åºå¾Œçš„åƒæ•¸}&HashIV={HashIV}"
)
```

#### ç”Ÿæˆæµç¨‹ï¼ˆç™¼é€çµ¦ ECPay æ™‚ï¼‰

```csharp
// EcpayService.cs:173-223
private string GenerateCheckMacValue(Dictionary<string, string> parameters, string hashKey, string hashIv)
{
    // 1. ç§»é™¤ CheckMacValue åƒæ•¸ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    var stringParams = new Dictionary<string, string>();
    foreach (var param in parameters)
    {
        if (param.Key != "CheckMacValue" && !string.IsNullOrEmpty(param.Value))
        {
            stringParams[param.Key] = param.Value.ToString();
        }
    }

    // 2. â­ æ’åºåƒæ•¸ï¼ˆæŒ‰å­—å…¸é †åºï¼‰
    var sortedParams = stringParams.OrderBy(x => x.Key).ToList();

    // 3. å»ºç«‹æŸ¥è©¢å­—ä¸²
    var queryString = string.Join("&", sortedParams.Select(p => $"{p.Key}={p.Value}"));

    // 4. çµ„åˆæœ€çµ‚å­—ä¸²
    var checkString = $"HashKey={hashKey}&{queryString}&HashIV={hashIv}";
    // ç¯„ä¾‹ï¼šHashKey=pwFHCqoQZGmho4w6&MerchantID=3002607&MerchantTradeNo=NGO20251229143052&...&HashIV=EkRm7iFT261dpevs

    // 5. URL ç·¨ç¢¼
    var encoded = System.Web.HttpUtility.UrlEncode(checkString, Encoding.UTF8).ToLower();

    // 6. å­—ç¬¦æ›¿æ›ï¼ˆECPay è¦ç¯„ï¼‰
    encoded = encoded.Replace("%21", "!")
                   .Replace("%2a", "*")
                   .Replace("%28", "(")
                   .Replace("%29", ")")
                   // ...

    // 7. â­ SHA256 åŠ å¯†
    using (var sha256 = SHA256.Create())
    {
        var hashBytes = sha256.ComputeHash(Encoding.UTF8.GetBytes(encoded));
        var result = BitConverter.ToString(hashBytes).Replace("-", "").ToUpper();
        return result;  // ç¯„ä¾‹ï¼šA1B2C3D4E5F6...ï¼ˆ64å­—ç¬¦ï¼‰
    }
}
```

#### é©—è­‰æµç¨‹ï¼ˆæ¥æ”¶ ECPay å›èª¿æ™‚ï¼‰

```csharp
// EcpayService.cs:226-267
private string GenerateCallbackCheckMacValue(Dictionary<string, string> parameters, string hashKey, string hashIv)
{
    // 1. ç§»é™¤ CheckMacValue åƒæ•¸
    var filteredParams = parameters
        .Where(kv => kv.Key != "CheckMacValue")
        .OrderBy(kv => kv.Key)
        .ToList();

    // 2-7. åŒæ¨£çš„è¨ˆç®—æµç¨‹...

    return result;
}

// ProcessCallback ä¸­çš„é©—è­‰
var receivedCheckMacValue = parameters["CheckMacValue"];      // ECPay å‚³ä¾†çš„
var calculatedCheckMacValue = GenerateCallbackCheckMacValue(...); // æˆ‘å€‘è¨ˆç®—çš„

if (calculatedCheckMacValue != receivedCheckMacValue)
{
    return false;  // â­ é©—è­‰å¤±æ•—ï¼Œå¯èƒ½æ˜¯å½é€ çš„å›èª¿ï¼
}
```

#### ç‚ºä»€éº¼é€™æ¨£å®‰å…¨ï¼Ÿ

```
æ”»æ“Šè€…æƒ³å½é€ å›èª¿ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ”»æ“Šè€…ç™¼é€å‡å›èª¿                              â”‚
â”‚ POST /Purchase/EcpayCallback                 â”‚
â”‚ {                                            â”‚
â”‚   "MerchantTradeNo": "NGO20251229143052",    â”‚
â”‚   "RtnCode": "1",    // å‡è£ä»˜æ¬¾æˆåŠŸ         â”‚
â”‚   "CheckMacValue": "FAKE_VALUE"  âŒ          â”‚
â”‚ }                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ æˆ‘å€‘çš„ç³»çµ±é©—è­‰ â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
   è¨ˆç®— CheckMacValue = SHA256(HashKey + åƒæ•¸ + HashIV)
                 â†“
   æ¯”å°ï¼šFAKE_VALUE != æ­£ç¢ºçš„CheckMacValue
                 â†“
           âŒ é©—è­‰å¤±æ•—ï¼Œæ‹’çµ•å›èª¿
```

**ç‚ºä»€éº¼æ”»æ“Šè€…ç„¡æ³•å½é€ ï¼Ÿ**
1. HashKey å’Œ HashIV åªæœ‰æˆ‘å€‘å’Œ ECPay çŸ¥é“
2. SHA256 æ˜¯ä¸å¯é€†çš„ï¼ˆç„¡æ³•å¾çµæœåæ¨åŸå§‹è³‡æ–™ï¼‰
3. å³ä½¿ä¿®æ”¹ä¸€å€‹å­—ç¬¦ï¼ŒCheckMacValue ä¹Ÿæœƒå®Œå…¨ä¸åŒ

### 2. [AllowAnonymous] çš„ä½¿ç”¨

```csharp
[HttpPost]
[AllowAnonymous]  // â­ ç‚ºä»€éº¼è¦å…è¨±åŒ¿åè¨ªå•ï¼Ÿ
public IActionResult EcpayCallback()
{
    // ECPay Server å›èª¿æ™‚ï¼Œæ²’æœ‰ç™»å…¥ç‹€æ…‹ï¼
}
```

**åŸå› **ï¼š
- ECPay Server æ˜¯å¦ä¸€å°æ©Ÿå™¨ï¼Œä¸æœƒæœ‰ç”¨æˆ¶çš„ Cookie
- å¦‚æœåŠ  `[Authorize]`ï¼ŒECPay å›èª¿æœƒè¢«æ‹’çµ•ï¼ˆ401 Unauthorizedï¼‰
- å®‰å…¨æ€§ç”± CheckMacValue é©—è­‰ä¿è­‰

### 3. è¨‚å–®ç·¨è™Ÿçš„å”¯ä¸€æ€§

```csharp
private string GenerateOrderNumber()
{
    var timestamp = DateTime.Now.ToString("yyyyMMddHHmmss");
    return $"NGO{timestamp}";  // NGO20251229143052
}
```

**ç‰¹é»**ï¼š
- åŒ…å«å®Œæ•´æ™‚é–“æˆ³ï¼ˆåˆ°ç§’ï¼‰
- å‰ç¶´ "NGO" æ¨™è­˜ç³»çµ±
- é•·åº¦ï¼š17 å­—ç¬¦ï¼ˆç¬¦åˆ ECPay 20 å­—ç¬¦é™åˆ¶ï¼‰

**ç‚ºä»€éº¼æ™‚é–“æˆ³èƒ½ä¿è­‰å”¯ä¸€ï¼Ÿ**
- åŒä¸€ç§’å…§åªæœƒç”Ÿæˆä¸€å€‹è¨‚å–®ï¼ˆå–®åŸ·è¡Œç·’ï¼‰
- å³ä½¿é«˜ä½µç™¼ï¼Œè³‡æ–™åº«çš„ UNIQUE ç´„æŸä¹Ÿæœƒé˜²æ­¢é‡è¤‡

---

## â“ é¢è©¦å¸¸è¦‹å•é¡Œ

### Q1ï¼šè«‹èªªæ˜ ECPay ç¶ ç•Œé‡‘æµçš„å®Œæ•´æµç¨‹

**å›ç­”æ¡†æ¶**ï¼š
1. **ç”¨æˆ¶é¸æ“‡ä»˜æ¬¾** â†’ å»ºç«‹è¨‚å–®ï¼ˆPaymentStatus: "å¾…ä»˜æ¬¾"ï¼‰
2. **ç”Ÿæˆä»˜æ¬¾è¡¨å–®** â†’ è¨ˆç®— CheckMacValueï¼ˆå®‰å…¨é©—è­‰ç¢¼ï¼‰
3. **è·³è½‰åˆ° ECPay** â†’ ç”¨æˆ¶åœ¨ç¶ ç•Œé é¢å®Œæˆä»˜æ¬¾
4. **Server å›èª¿ï¼ˆReturnURLï¼‰** â†’ é©—è­‰å®‰å…¨æ€§ã€æ›´æ–°è¨‚å–®ã€æ›´æ–°åº«å­˜
5. **é é¢è·³è½‰ï¼ˆClientBackURLï¼‰** â†’ ç”¨æˆ¶çœ‹åˆ°æˆåŠŸé é¢

**æŠ€è¡“äº®é»**ï¼š
- ä½¿ç”¨ **å…©å€‹ URL** ç¢ºä¿ç‹€æ…‹ä¸€è‡´æ€§
- **SHA256 åŠ å¯†** é˜²æ­¢å½é€ å›èª¿
- **Cloudflare Tunnel** è§£æ±ºæœ¬åœ°é–‹ç™¼å•é¡Œ

---

### Q2ï¼šReturnURL å’Œ ClientBackURL æœ‰ä»€éº¼å€åˆ¥ï¼Ÿ

| å°æ¯”é … | ReturnURL | ClientBackURL |
|--------|-----------|---------------|
| **è¨ªå•æ–¹** | ECPay Server | ç”¨æˆ¶ç€è¦½å™¨ |
| **æ™‚æ©Ÿ** | ä»˜æ¬¾å®Œæˆå¾Œç«‹å³ | ä»˜æ¬¾å®Œæˆå¾Œ |
| **ç”¨é€”** | æ›´æ–°è¨‚å–®ç‹€æ…‹ã€é©—è­‰å®‰å…¨æ€§ | é¡¯ç¤ºçµæœçµ¦ç”¨æˆ¶ |
| **å¯é æ€§** | âœ… å¿…å®šåŸ·è¡Œ | âŒ ç”¨æˆ¶å¯èƒ½é—œé–‰ç€è¦½å™¨ |
| **æˆæ¬Š** | [AllowAnonymous] | å¯é¸ |

**ç‚ºä»€éº¼éœ€è¦å…©å€‹ï¼Ÿ**
- ReturnURL ä¿è­‰è³‡æ–™æ­£ç¢ºæ€§ï¼ˆå³ä½¿ç”¨æˆ¶é—œé–‰ç€è¦½å™¨ï¼‰
- ClientBackURL æä¾›è‰¯å¥½çš„ç”¨æˆ¶é«”é©—

---

### Q3ï¼šCheckMacValue æ˜¯ä»€éº¼ï¼Ÿå¦‚ä½•ä¿è­‰å®‰å…¨æ€§ï¼Ÿ

**ç°¡å–®å›ç­”**ï¼š
CheckMacValue æ˜¯ä¸€å€‹ SHA256 åŠ å¯†çš„é©—è­‰ç¢¼ï¼Œç¢ºä¿ ECPay å›èª¿çš„è³‡æ–™æ²’æœ‰è¢«ç«„æ”¹ã€‚

**è©³ç´°èªªæ˜**ï¼š

1. **è¨ˆç®—æ–¹å¼**ï¼š
   ```
   CheckMacValue = SHA256("HashKey={å¯†é‘°}&{æ’åºåƒæ•¸}&HashIV={å‘é‡}")
   ```

2. **å®‰å…¨æ©Ÿåˆ¶**ï¼š
   - HashKey å’Œ HashIV åªæœ‰æˆ‘å€‘å’Œ ECPay çŸ¥é“
   - SHA256 ä¸å¯é€†ï¼Œæ”»æ“Šè€…ç„¡æ³•å½é€ 
   - åƒæ•¸å¿…é ˆæ’åºï¼Œç¢ºä¿ä¸€è‡´æ€§

3. **é©—è­‰æµç¨‹**ï¼š
   - æ¥æ”¶ ECPay å›èª¿æ™‚ï¼Œæˆ‘å€‘é‡æ–°è¨ˆç®— CheckMacValue
   - æ¯”å°è¨ˆç®—å€¼èˆ‡æ¥æ”¶å€¼
   - ä¸ä¸€è‡´ â†’ æ‹’çµ•å›èª¿ï¼ˆå¯èƒ½æ˜¯æ”»æ“Šï¼‰

---

### Q4ï¼šå¦‚ä½•ç¢ºä¿ç”¨æˆ¶è³‡è¨Šæ­£ç¢ºï¼Ÿï¼ˆç‹€æ…‹ç®¡ç†ï¼‰

**å›ç­”**ï¼š

1. **è¨‚å–®ç·¨è™Ÿå”¯ä¸€æ€§**ï¼š
   ```csharp
   OrderNumber = "NGO" + DateTime.Now.ToString("yyyyMMddHHmmss");
   // NGO20251229143052ï¼ˆæ™‚é–“æˆ³ä¿è­‰å”¯ä¸€ï¼‰
   ```

2. **ç‹€æ…‹è½‰æ›è¿½è¹¤**ï¼š
   ```
   "å¾…ä»˜æ¬¾" â†’ (ä»˜æ¬¾å®Œæˆ) â†’ "å·²ä»˜æ¬¾"
   ```

3. **è³‡æ–™åº«äº¤æ˜“**ï¼š
   - è¨‚å–®è¡¨ï¼ˆUserOrderï¼‰è¨˜éŒ„ç”¨æˆ¶IDã€é‡‘é¡ã€ç‹€æ…‹
   - äº¤æ˜“è¡¨ï¼ˆEcpayTransactionï¼‰è¨˜éŒ„ ECPay å›èª¿è³‡æ–™
   - å¤–éµç´„æŸä¿è­‰è³‡æ–™ä¸€è‡´æ€§

4. **å†ªç­‰æ€§è¨­è¨ˆ**ï¼š
   - å³ä½¿ ECPay é‡è¤‡å›èª¿ï¼Œä¹Ÿåªæ›´æ–°ä¸€æ¬¡
   - æª¢æŸ¥è¨‚å–®ç‹€æ…‹ï¼Œé¿å…é‡è¤‡è™•ç†

---

### Q5ï¼šç‚ºä»€éº¼éœ€è¦ Cloudflare Tunnelï¼Ÿ

**å•é¡Œ**ï¼š
- localhost åªèƒ½åœ¨æœ¬æ©Ÿè¨ªå•
- ECPay Server éœ€è¦**å…¬é–‹ç¶²å€**æ‰èƒ½å›èª¿

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
```
localhost:5066  âŒ ECPay ç„¡æ³•è¨ªå•
    â†“ Cloudflare Tunnel
https://extended-prep-garden-manufacture.trycloudflare.com  âœ…
```

**å„ªé»**ï¼š
- å…è²»
- ç„¡éœ€è­¦å‘Šé ï¼ˆæ¯” ngrok å¥½ï¼‰
- ç©©å®šæ€§é«˜

---

### Q6ï¼šå¦‚æœä»˜æ¬¾æˆåŠŸä½†åº«å­˜æ²’æ›´æ–°æ€éº¼è¾¦ï¼Ÿ

**å•é¡Œåˆ†æ**ï¼š
- ReturnURL å›èª¿ä¸­æœƒæ›´æ–°åº«å­˜
- å¦‚æœå›èª¿å¤±æ•—ï¼Œè³‡æ–™ä¸ä¸€è‡´

**é˜²è­·æ©Ÿåˆ¶**ï¼š

1. **äº¤æ˜“è¨˜éŒ„**ï¼š
   ```csharp
   EcpayTransaction è¡¨è¨˜éŒ„æ‰€æœ‰å›èª¿è³‡æ–™ï¼ˆResponseDataï¼‰
   ```

2. **æ‰‹å‹•æª¢æŸ¥**ï¼š
   - ç®¡ç†å“¡å¯æŸ¥çœ‹ PaymentStatus = "å·²ä»˜æ¬¾" ä½†åº«å­˜æœªæ›´æ–°çš„è¨‚å–®
   - æ‰‹å‹•è§¸ç™¼åº«å­˜æ›´æ–°

3. **é‡è©¦æ©Ÿåˆ¶**ï¼ˆå¯æ“´å±•ï¼‰ï¼š
   - ECPay æœƒé‡è©¦å›èª¿ï¼ˆå¦‚æœæ”¶åˆ°é "1|OK"ï¼‰
   - æˆ‘å€‘å¯ä»¥å¯¦ä½œæ’ç¨‹ä»»å‹™å®šæœŸæª¢æŸ¥

---

### Q7ï¼šæ¸¬è©¦ç’°å¢ƒå’Œæ­£å¼ç’°å¢ƒæœ‰ä»€éº¼å€åˆ¥ï¼Ÿ

| é …ç›® | æ¸¬è©¦ç’°å¢ƒ | æ­£å¼ç’°å¢ƒ |
|------|---------|---------|
| **API ç¶²å€** | https://payment-stage.ecpay.com.tw | https://payment.ecpay.com.tw |
| **å•†åº—ä»£è™Ÿ** | 3002607 (æ¸¬è©¦) | å¯¦éš›ç”³è«‹çš„å•†åº—ä»£è™Ÿ |
| **HashKey/IV** | æ¸¬è©¦ç”¨å¯†é‘° | æ­£å¼å¯†é‘° |
| **æ¸¬è©¦å¡è™Ÿ** | 4311-9511-1111-1111 | çœŸå¯¦ä¿¡ç”¨å¡ |
| **å¯¦éš›æ‰£æ¬¾** | âŒ ä¸æœƒ | âœ… æœƒ |

**åˆ‡æ›æ–¹å¼**ï¼š
```csharp
// appsettings.json
{
  "ECPay": {
    "IsProduction": false,  // true = æ­£å¼ç’°å¢ƒ
    "MerchantID": "3002607",
    "HashKey": "pwFHCqoQZGmho4w6",
    "HashIV": "EkRm7iFT261dpevs"
  }
}
```

---

## ğŸ’¡ æŠ€è¡“äº®é»ï¼ˆé¢è©¦åŠ åˆ†é …ï¼‰

### 1. é›™é‡ URL è¨­è¨ˆ

```
âœ¨ äº®é»ï¼šåŒæ™‚ä½¿ç”¨ ReturnURL å’Œ ClientBackURL

å„ªå‹¢ï¼š
- ç¢ºä¿è³‡æ–™ä¸€è‡´æ€§ï¼ˆReturnURL å¿…å®šåŸ·è¡Œï¼‰
- æä¾›è‰¯å¥½ç”¨æˆ¶é«”é©—ï¼ˆClientBackURL é¡¯ç¤ºçµæœï¼‰
- ç¬¦åˆé‡‘æµæ¥­ç•Œæœ€ä½³å¯¦è¸
```

### 2. SHA256 å®‰å…¨é©—è­‰

```
âœ¨ äº®é»ï¼šä½¿ç”¨ SHA256 åŠ å¯† + HashKey/HashIV é›™é‡ä¿è­·

å„ªå‹¢ï¼š
- é˜²æ­¢å›èª¿å½é€ 
- ç¬¦åˆ PCI DSS å®‰å…¨æ¨™æº–
- ä¸å¯é€†åŠ å¯†ï¼Œé«˜å®‰å…¨æ€§
```

### 3. Cloudflare Tunnel è§£æ±ºæ–¹æ¡ˆ

```
âœ¨ äº®é»ï¼šä½¿ç”¨ Cloudflare Tunnel è€Œé ngrok

å„ªå‹¢ï¼š
- å…è²»ã€ç©©å®š
- ç„¡è­¦å‘Šé é¢
- æ”¯æ´æœ¬åœ°é–‹ç™¼æ¸¬è©¦é‡‘æµ
```

### 4. è³‡æ–™åº«è¨­è¨ˆ

```
âœ¨ äº®é»ï¼šåˆ†é›¢è¨‚å–®è¡¨å’Œäº¤æ˜“è¡¨

UserOrderï¼ˆè¨‚å–®ï¼‰
- è¨˜éŒ„æ¥­å‹™è³‡æ–™ï¼ˆç”¨æˆ¶ã€é‡‘é¡ã€ç‹€æ…‹ï¼‰

EcpayTransactionï¼ˆäº¤æ˜“ï¼‰
- è¨˜éŒ„ ECPay å›èª¿è³‡æ–™ï¼ˆè¿½è¹¤ã€èª¿è©¦ï¼‰

å„ªå‹¢ï¼š
- è·è²¬åˆ†é›¢ï¼ˆSRP åŸå‰‡ï¼‰
- ä¾¿æ–¼è¿½è¹¤å’Œèª¿è©¦
- æ”¯æ´å¤šç¨®ä»˜æ¬¾æ–¹å¼æ“´å±•
```

### 5. å†ªç­‰æ€§è¨­è¨ˆ

```
âœ¨ äº®é»ï¼šé‡è¤‡å›èª¿ä¸æœƒé€ æˆè³‡æ–™éŒ¯èª¤

æª¢æŸ¥æ©Ÿåˆ¶ï¼š
if (order.PaymentStatus != "å¾…ä»˜æ¬¾")
{
    return true;  // å·²è™•ç†éï¼Œç›´æ¥è¿”å›æˆåŠŸ
}

å„ªå‹¢ï¼š
- é˜²æ­¢é‡è¤‡æ‰£æ¬¾
- é˜²æ­¢åº«å­˜é‡è¤‡å¢åŠ 
- æé«˜ç³»çµ±å¥å£¯æ€§
```

---

## ğŸ“ é¢è©¦æº–å‚™æª¢æŸ¥æ¸…å–®

### å¿…é ˆèƒ½å›ç­”çš„å•é¡Œ

- [ ] ECPay ä»˜æ¬¾æµç¨‹ï¼ˆå¾é»æ“Šä»˜æ¬¾åˆ°å®Œæˆï¼‰
- [ ] ReturnURL å’Œ ClientBackURL çš„å€åˆ¥å’Œç”¨é€”
- [ ] CheckMacValue çš„ä½œç”¨å’Œè¨ˆç®—æ–¹å¼
- [ ] å¦‚ä½•ç¢ºä¿è¨‚å–®ç‹€æ…‹ä¸€è‡´æ€§
- [ ] ç‚ºä»€éº¼éœ€è¦ Cloudflare Tunnel
- [ ] å®‰å…¨æ©Ÿåˆ¶ï¼ˆé˜²å½é€ å›èª¿ï¼‰
- [ ] æ¸¬è©¦ç’°å¢ƒ vs æ­£å¼ç’°å¢ƒ
- [ ] å¦‚ä½•è™•ç†ç•°å¸¸æƒ…æ³ï¼ˆä»˜æ¬¾å¤±æ•—ã€å›èª¿å¤±æ•—ç­‰ï¼‰

### èƒ½å±•ç¤ºçš„ç¨‹å¼ç¢¼ç‰‡æ®µ

1. **è¨‚å–®å»ºç«‹**ï¼ˆPurchaseController.cs:329-333ï¼‰
2. **ç”Ÿæˆä»˜æ¬¾è¡¨å–®**ï¼ˆEcpayService.cs:76-98ï¼‰
3. **CheckMacValue è¨ˆç®—**ï¼ˆEcpayService.cs:173-223ï¼‰
4. **å›èª¿é©—è­‰**ï¼ˆEcpayService.cs:116-170ï¼‰
5. **åº«å­˜æ›´æ–°**ï¼ˆEcpayService.cs:286-337ï¼‰

### æŠ€è¡“æ–‡æª”

- âœ… æœ¬æ–‡æª”ï¼ˆECPay æŠ€è¡“åˆ†æï¼‰
- âœ… æ¸¬è©¦å¸³è™Ÿæ–‡æª”ï¼ˆdocs/03-æ¸¬è©¦å¸³è™Ÿ.mdï¼‰
- âœ… Cloudflare å±•ç¤ºæŒ‡å—ï¼ˆdocs/02-Cloudflareå±•ç¤ºæŒ‡å—.mdï¼‰

---

## ğŸ¯ é¢è©¦è©±è¡“ç¯„ä¾‹

### æƒ…å¢ƒï¼šé¢è©¦å®˜å•ã€Œä½ åœ¨é€™å€‹å°ˆæ¡ˆä¸­è² è²¬ä»€éº¼ï¼Ÿã€

**å›ç­”ç¯„ä¾‹**ï¼š

> "æˆ‘åœ¨é€™å€‹ NGO å°ˆæ¡ˆä¸­è² è²¬æ•´åˆ ECPay ç¶ ç•Œé‡‘æµã€‚é€™æ˜¯ä¸€å€‹å¾é›¶é–‹å§‹çš„å®Œæ•´å¯¦ä½œï¼ŒåŒ…å«ä»¥ä¸‹å¹¾å€‹é—œéµé»ï¼š
>
> 1. **ä»˜æ¬¾æµç¨‹è¨­è¨ˆ**ï¼šæˆ‘å¯¦ä½œäº†å®Œæ•´çš„é‡‘æµä¸²æ¥ï¼Œä½¿ç”¨ ReturnURL å’Œ ClientBackURL é›™é‡æ©Ÿåˆ¶ï¼Œç¢ºä¿å³ä½¿ç”¨æˆ¶é—œé–‰ç€è¦½å™¨ï¼Œè¨‚å–®ç‹€æ…‹ä»ç„¶æ­£ç¢ºæ›´æ–°ã€‚
>
> 2. **å®‰å…¨æ©Ÿåˆ¶**ï¼šä½¿ç”¨ SHA256 åŠ å¯†ç”Ÿæˆ CheckMacValueï¼Œé˜²æ­¢å›èª¿å½é€ ã€‚æ‰€æœ‰ ECPay å›èª¿éƒ½æœƒç¶“éåš´æ ¼çš„é©—è­‰ï¼Œç¢ºä¿è³‡æ–™æœªè¢«ç«„æ”¹ã€‚
>
> 3. **æœ¬åœ°é–‹ç™¼è§£æ±ºæ–¹æ¡ˆ**ï¼šç”±æ–¼ ECPay éœ€è¦å…¬é–‹ç¶²å€é€²è¡Œå›èª¿ï¼Œæˆ‘ä½¿ç”¨ Cloudflare Tunnel å°‡æœ¬åœ°é–‹ç™¼ç’°å¢ƒæš´éœ²ç‚ºå…¬é–‹ç¶²å€ï¼Œå¤§å¹…æå‡é–‹ç™¼æ•ˆç‡ã€‚
>
> 4. **ç‹€æ…‹ç®¡ç†**ï¼šè¨­è¨ˆäº†è¨‚å–®è¡¨å’Œäº¤æ˜“è¡¨åˆ†é›¢çš„è³‡æ–™åº«æ¶æ§‹ï¼Œè¨‚å–®ç‹€æ…‹å¾ã€Œå¾…ä»˜æ¬¾ã€åˆ°ã€Œå·²ä»˜æ¬¾ã€æœ‰å®Œæ•´çš„è¿½è¹¤ï¼Œä¸¦ä¸”å¯¦ä½œäº†å†ªç­‰æ€§è¨­è¨ˆï¼Œé¿å…é‡è¤‡å›èª¿é€ æˆè³‡æ–™éŒ¯èª¤ã€‚
>
> 5. **åº«å­˜ç®¡ç†**ï¼šä»˜æ¬¾æˆåŠŸå¾Œï¼Œç³»çµ±æœƒè‡ªå‹•æ›´æ–°ç·Šæ€¥ç‰©è³‡çš„å‹Ÿé›†é€²åº¦ï¼Œä¸¦åœ¨é”æˆç›®æ¨™æ™‚è‡ªå‹•è®Šæ›´ç‹€æ…‹ã€‚
>
> é€™å€‹åŠŸèƒ½ç›®å‰å·²ç¶“éƒ¨ç½²ä¸Šç·šï¼Œä½¿ç”¨æ¸¬è©¦ç’°å¢ƒçš„è©±ï¼Œå¯ä»¥ç”¨æ¸¬è©¦å¡è™Ÿ 4311-9511-1111-1111 é€²è¡Œå®Œæ•´çš„ä»˜æ¬¾æ¸¬è©¦ã€‚"

---

## ğŸ“š ç›¸é—œæ–‡æª”

- [æ¸¬è©¦å¸³è™Ÿèˆ‡ ECPay æ¸¬è©¦å¡](03-æ¸¬è©¦å¸³è™Ÿ.md#ecpay-ç¶ ç•Œé‡‘æµæ¸¬è©¦)
- [Cloudflare å±•ç¤ºæŒ‡å—](02-Cloudflareå±•ç¤ºæŒ‡å—.md)
- [å¿«é€Ÿå•Ÿå‹•æŒ‡å—](00-å¿«é€Ÿé–‹å§‹.md)

---

**æœ€å¾Œæ›´æ–°**ï¼š2025-12-29
**ä½œè€…**ï¼šNGO é–‹ç™¼åœ˜éšŠ
