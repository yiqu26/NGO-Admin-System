# NGO 專案免費部署指南

**目標**：將專案免費部署上線，供求職展示使用（1個月穩定）

**架構**：
```
前端 React      → Vercel（免費、穩定 URL）
後端 WebAPI     → Render（免費、穩定 URL）
資料庫 SQL Server → 本地 + ngrok tunnel
```

---

## ✅ 優點

- ✅ **完全免費**：三個服務都是免費層
- ✅ **專業網址**：面試官看到的是正式網域
- ✅ **不改資料庫**：保持原有 SQL Server 架構
- ✅ **適合求職**：展示 1 個月絕對穩定

## ⚠️ 限制

- 展示期間電腦需要開著（運行 ngrok tunnel）
- Render 免費層閒置 15 分鐘會休眠（第一次訪問需等待 30 秒喚醒）

---

## 📋 前置準備

### 1. 註冊帳號

| 服務 | 網址 | 說明 |
|------|------|------|
| **Vercel** | https://vercel.com | 用 GitHub 帳號登入即可 |
| **Render** | https://render.com | 用 GitHub 帳號登入即可 |
| **ngrok** | https://ngrok.com | 註冊免費帳號，取得 authtoken |

### 2. 安裝工具

- **Git**：確保專案已推送到 GitHub
- **ngrok**：下載安裝 https://ngrok.com/download

### 3. 建立 GitHub Repository

如果還沒有 GitHub Repository：

```bash
cd C:\Users\lanli\source\repos

# 初始化前端專案的 git
cd NGO-Admin-System
git init
git add .
git commit -m "Initial commit - React frontend"
git branch -M main
git remote add origin https://github.com/你的帳號/NGO-Admin-System.git
git push -u origin main

# 初始化後端專案的 git
cd ../NGO-Admin-System-WebAPI
git init
git add .
git commit -m "Initial commit - WebAPI backend"
git branch -M main
git remote add origin https://github.com/你的帳號/NGO-Admin-System-WebAPI.git
git push -u origin main
```

---

## 🚀 部署步驟

### 步驟 1：部署後端到 Render

#### 1.1 登入 Render
- 前往 https://render.com
- 用 GitHub 帳號登入

#### 1.2 建立新 Web Service
1. 點擊 "New +" → "Web Service"
2. 連接你的 GitHub Repository：`NGO-Admin-System-WebAPI`
3. 設定如下：

| 欄位 | 值 |
|------|-----|
| **Name** | `ngo-webapi`（或你喜歡的名稱） |
| **Environment** | `Docker` |
| **Plan** | `Free` |
| **Dockerfile Path** | `./Dockerfile` |

#### 1.3 設定環境變數

點擊 "Environment" 標籤，新增以下環境變數：

| Key | Value |
|-----|-------|
| `ASPNETCORE_ENVIRONMENT` | `Production` |
| `Jwt__Key` | 隨機生成一個長字串（例如：`your-super-secret-jwt-key-at-least-32-characters-long`） |
| `Jwt__Issuer` | `NGO_WebAPI` |
| `Jwt__Audience` | `NGO_React_Frontend` |
| `Jwt__ExpireMinutes` | `60` |
| `ConnectionStrings__DefaultConnection` | **先留空，等 ngrok 設定好後再填** |

#### 1.4 部署

點擊 "Create Web Service"，Render 會開始自動部署。

部署完成後，你會得到一個網址，例如：
```
https://ngo-webapi.onrender.com
```

**記下這個網址**，稍後前端會用到！

---

### 步驟 2：設定 ngrok Tunnel（資料庫連線）

#### 2.1 安裝並設定 ngrok

1. 下載 ngrok：https://ngrok.com/download
2. 註冊並取得 authtoken：https://dashboard.ngrok.com/get-started/your-authtoken
3. 設定 authtoken：

```bash
ngrok config add-authtoken 你的_AUTHTOKEN
```

#### 2.2 啟動 SQL Server Tunnel

**方式一：使用提供的批次檔**
```bash
cd C:\Users\lanli\source\repos
start-ngrok-tunnel.bat
```

**方式二：手動執行**
```bash
ngrok tcp 1433
```

#### 2.3 取得 ngrok 連線資訊

ngrok 啟動後會顯示類似這樣的資訊：
```
Forwarding  tcp://0.tcp.ngrok.io:12345 -> localhost:1433
```

**記下這個網址和 port**（例如：`0.tcp.ngrok.io:12345`）

#### 2.4 建立連線字串

根據 ngrok 資訊，建立連線字串：

```
Server=0.tcp.ngrok.io,12345;Database=NGOPlatformDb;User Id=sa;Password=你的SQL密碼;TrustServerCertificate=True;
```

⚠️ **注意**：
- Server 和 port 之間用**逗號**分隔
- 需要使用 SQL Server 驗證（不能用 Windows 驗證）

#### 2.5 測試 SQL Server 驗證

如果你的 SQL Server 還沒啟用 SQL 驗證，需要先設定：

1. 開啟 **SQL Server Management Studio (SSMS)**
2. 右鍵伺服器 → **屬性**
3. **安全性** → 選擇 **SQL Server 及 Windows 驗證模式**
4. 重新啟動 SQL Server 服務

建立或啟用 `sa` 帳號：
```sql
-- 啟用 sa 帳號
ALTER LOGIN sa ENABLE;
GO

-- 設定 sa 密碼
ALTER LOGIN sa WITH PASSWORD = '你的強密碼';
GO
```

#### 2.6 更新 Render 的連線字串

回到 Render Dashboard：
1. 找到你的 Web Service
2. 進入 **Environment** 標籤
3. 更新 `ConnectionStrings__DefaultConnection` 為上面建立的連線字串
4. 點擊 **Save Changes**
5. Render 會自動重新部署

---

### 步驟 3：部署前端到 Vercel

#### 3.1 登入 Vercel
- 前往 https://vercel.com
- 用 GitHub 帳號登入

#### 3.2 匯入專案
1. 點擊 "Add New..." → "Project"
2. 從 GitHub 匯入：`NGO-Admin-System`
3. Vercel 會自動偵測到這是 Vite 專案

#### 3.3 設定環境變數

在 "Environment Variables" 區域，新增以下變數：

| Name | Value |
|------|-------|
| `VITE_API_BASE_URL` | `https://ngo-webapi.onrender.com/api` |
| `VITE_APP_NAME` | `NGO案管系統` |
| `VITE_APP_VERSION` | `1.0.0` |
| `VITE_APP_ENV` | `production` |
| `VITE_ENABLE_AZURE_LOGIN` | `false` |
| `VITE_REQUEST_TIMEOUT` | `10000` |
| `VITE_MAX_FILE_SIZE` | `5242880` |
| `VITE_ALLOWED_FILE_TYPES` | `image/jpeg,image/png,image/gif` |
| `VITE_DEFAULT_PAGE_SIZE` | `10` |

⚠️ **重要**：`VITE_API_BASE_URL` 要填入 Render 給你的後端網址！

#### 3.4 部署

點擊 "Deploy"，Vercel 會自動建置並部署。

部署完成後，你會得到一個網址，例如：
```
https://ngo-admin-system.vercel.app
```

---

## 🧪 測試部署結果

### 1. 測試後端 API

開啟瀏覽器訪問：
```
https://ngo-webapi.onrender.com
```

應該看到類似 "NGO API 運作正常" 的訊息。

⚠️ **第一次訪問會慢**：Render 免費層閒置會休眠，第一次訪問需等 30 秒喚醒。

### 2. 測試前端

開啟瀏覽器訪問你的 Vercel 網址：
```
https://ngo-admin-system.vercel.app
```

應該看到登入頁面。

### 3. 測試登入

使用你的測試帳號登入：
```
Email: admin@ngo.org
密碼: Admin123!
```

如果能成功登入並看到 Dashboard，恭喜你部署成功！🎉

---

## 🔧 CORS 設定檢查

如果前端無法連接後端，檢查 WebAPI 的 CORS 設定。

編輯 `NGO-Admin-System-WebAPI/Program.cs`，確保有以下設定：

```csharp
// 允許前端網域
builder.Services.AddCors(options =>
{
    options.AddPolicy("AllowVercel", policy =>
    {
        policy.WithOrigins(
            "https://ngo-admin-system.vercel.app",  // 改成你的 Vercel 網址
            "http://localhost:5173"                  // 本地開發
        )
        .AllowAnyHeader()
        .AllowAnyMethod()
        .AllowCredentials();
    });
});

// 在 app.Use... 之前添加
app.UseCors("AllowVercel");
```

修改後重新 commit 並 push 到 GitHub，Render 會自動重新部署。

---

## 📝 日常使用流程

### 展示前準備（每次）

1. **啟動電腦和 SQL Server**
2. **啟動 ngrok tunnel**：
   ```bash
   cd C:\Users\lanli\source\repos
   start-ngrok-tunnel.bat
   ```
3. **確認 ngrok 連線資訊是否改變**
   - 免費版 ngrok 每次重啟，網址和 port 會改變
   - 如果改變了，需要更新 Render 的連線字串

### 如果 ngrok 網址變了

1. 記下新的 ngrok 網址（例如：`1.tcp.ngrok.io:23456`）
2. 建立新的連線字串
3. 前往 Render Dashboard 更新環境變數
4. 等待 Render 自動重新部署（約 1-2 分鐘）

### 檢查系統狀態

- **前端**：https://ngo-admin-system.vercel.app
- **後端**：https://ngo-webapi.onrender.com
- **ngrok**：在終端機確認 tunnel 正在運行

---

## 💡 進階優化（選用）

### 1. ngrok 固定網域（付費）

如果不想每次都更新連線字串，可以購買 ngrok 付費方案：
- **個人版**：$8/月，提供固定網域
- 網址不會改變，設定一次就好

### 2. 使用 ngrok 設定檔

編輯 `ngrok-config.yml`：
```yaml
version: "2"
authtoken: YOUR_AUTHTOKEN_HERE

tunnels:
  sql-server:
    proto: tcp
    addr: 1433
```

啟動時使用：
```bash
ngrok start --all --config ngrok-config.yml
```

### 3. 自動啟動腳本

建立一個批次檔同時啟動所有服務：
```batch
@echo off
start "SQL Server ngrok" cmd /k "cd C:\Users\lanli\source\repos && ngrok tcp 1433"
timeout /t 5
start "Check Services" cmd /k "curl https://ngo-webapi.onrender.com && curl https://ngo-admin-system.vercel.app"
```

---

## 🚨 常見問題排除

### Q1: 前端無法連接後端（CORS 錯誤）

**檢查**：
1. Render 的 WebAPI 是否正常運行？
2. CORS 設定是否包含你的 Vercel 網址？
3. 瀏覽器 Console 顯示什麼錯誤？

**解決**：
- 更新 `Program.cs` 的 CORS 設定
- 確保 Vercel 網址正確

### Q2: 後端無法連接資料庫

**檢查**：
1. ngrok tunnel 是否正在運行？
2. SQL Server 是否啟動？
3. SQL Server 驗證是否啟用？
4. 連線字串格式是否正確？

**測試連線**：
```bash
# 在本地測試 ngrok 是否可以連到 SQL Server
sqlcmd -S 0.tcp.ngrok.io,12345 -U sa -P 你的密碼
```

### Q3: Render 服務休眠

**現象**：第一次訪問很慢（30 秒）

**原因**：Render 免費層閒置 15 分鐘會休眠

**解決方式**：
- 接受現狀（對求職展示影響不大）
- 使用 UptimeRobot 定期 ping 你的 API（每 5 分鐘）
- 升級到付費方案

### Q4: ngrok 網址一直變

**原因**：免費版 ngrok 每次重啟會換網址

**解決方式**：
- 升級 ngrok 付費方案（$8/月）
- 或接受每次重啟後手動更新

### Q5: Vercel 建置失敗

**檢查**：
1. `package.json` 的 `build` 指令是否正確？
2. 環境變數是否都設定了？
3. TypeScript 編譯是否有錯誤？

**查看 Logs**：
- 在 Vercel Dashboard 查看建置日誌
- 修正錯誤後重新部署

---

## 📊 系統架構圖

```
┌─────────────────────────────────────────────────────┐
│                      使用者                           │
│              (面試官/求職展示)                         │
└────────────────────┬────────────────────────────────┘
                     │
         ┌───────────┴───────────┐
         │                       │
         ▼                       ▼
┌─────────────────┐    ┌──────────────────┐
│  Vercel (免費)   │    │  Render (免費)    │
│  React 前端      │───→│  WebAPI 後端     │
│  穩定網址        │ API │  穩定網址         │
└─────────────────┘    └────────┬─────────┘
                                │
                                │ SQL 查詢
                                ▼
                    ┌────────────────────┐
                    │   ngrok Tunnel     │
                    │   (免費/付費)       │
                    └─────────┬──────────┘
                              │
                              ▼
                    ┌────────────────────┐
                    │   你的電腦          │
                    │  SQL Server 資料庫  │
                    └────────────────────┘
```

---

## ✅ 檢查清單

部署前：
- [ ] 已註冊 Vercel、Render、ngrok 帳號
- [ ] 專案已推送到 GitHub
- [ ] SQL Server 已啟用 SQL 驗證
- [ ] 已建立測試帳號

部署中：
- [ ] Render WebAPI 部署成功
- [ ] Vercel 前端部署成功
- [ ] ngrok tunnel 正常運行
- [ ] 連線字串已更新

部署後：
- [ ] 可以訪問前端網址
- [ ] 可以訪問後端 API
- [ ] 可以成功登入
- [ ] Dashboard 資料正常顯示

---

## 🎉 完成！

恭喜你完成部署！現在你有：

✅ 專業的前端網址：`https://ngo-admin-system.vercel.app`
✅ 穩定的後端 API：`https://ngo-webapi.onrender.com`
✅ 完全免費的解決方案
✅ 適合放在履歷上的作品集

---

## 📞 需要幫助？

如果遇到問題：

1. **查看日誌**
   - Vercel：Dashboard → 專案 → Deployments → 點擊最新部署查看 Logs
   - Render：Dashboard → 服務 → Logs 標籤

2. **測試 API**
   - 使用 Postman 或 curl 測試 API 端點
   - 檢查回應是否正常

3. **檢查環境變數**
   - Vercel 和 Render 的環境變數是否正確設定
   - 特別注意 API 網址和連線字串

---

**祝求職順利！** 🚀
